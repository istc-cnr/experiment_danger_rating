<!DOCTYPE html>
<html>
<head>
    <title>Language Learning Experiment</title>
    <script src="https://unpkg.com/jspsych@7.3.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.2"></script>
    <link href="https://unpkg.com/jspsych@7.3.3/css/jspsych.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="utils.js"></script>
</head>
<body></body>
<script>
    const userID = generateUID();
    
    const jsPsych = initJsPsych({
        show_progress_bar: true,
        message_progress_bar: 'Progress',
        on_finish: function() {
            const allTrials = jsPsych.data.get().trials;
            console.log('Raw trials:', allTrials);
            
            const sentenceTrials = allTrials.filter(trial => 
                trial.trial_type === 'html-button-response' && 
                trial.english && 
                trial.italian
            );
            console.log('Sentence trials:', sentenceTrials);
            
            const finalData = {
                demographics: {
                    age: allTrials[0].age || null,
                    gender: allTrials[0].gender || null
                },
                trials: sentenceTrials.map(trial => ({
                    english: trial.english,
                    italian: trial.italian,
                    danger_rating: trial.danger_rating,
                    response_time_ms: trial.rt,
                    trial_number: trial.trial_index
                })),
                total_time_ms: allTrials[allTrials.length - 1].time_elapsed
            };

            console.log('Final data being sent:', finalData);
            saveToMongoDB(finalData, userID)
                .then(() => {
                    document.body.innerHTML = `
                        <div style="text-align: center; margin-top: 50px;">
                            <h2>Thank you for participating!</h2>
                            <p>Your responses have been saved.</p>
                            <p>You may close this window.</p>
                        </div>
                    `;
                }).catch(error => {
                    console.error('Failed to save data:', error);
                    document.body.innerHTML = `
                        <div style="text-align: center; margin-top: 50px;">
                            <h2>Error Saving Data</h2>
                            <p>There was a problem saving your responses. Please contact the experiment administrator.</p>
                        </div>
                    `;
                });
        }
    });

    async function loadExperiment() {
        try {
            const baseUrl = window.location.pathname.endsWith('/') 
                ? window.location.pathname 
                : window.location.pathname + '/';
                
            const [sentencesResponse, instructionsResponse] = await Promise.all([
                fetch(new URL('randomized_sentences.json', window.location.href)),
                fetch(new URL('instructions.html', window.location.href))
            ]);
            
            if (!sentencesResponse.ok) {
                throw new Error(`Failed to load sentences: ${sentencesResponse.status}`);
            }

            if (!instructionsResponse.ok) {
                throw new Error(`Failed to load instructions: ${instructionsResponse.status}`);
            }

            const sentences = await sentencesResponse.json();
            const instructionsContent = await instructionsResponse.text();
            const welcome = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `
                    <h1>Welcome to the Sentence Danger Rating Experiment</h1>
                    <p>You will evaluate English-Italian sentence pairs for their level of danger.</p>
                `,
                choices: ['Start the experiment'],
                button_html: '<button class="jspsych-btn" style="background-color: #3498db; color: white; font-size: 18px; padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">%choice%</button>'
            };

            const demographics = {
                type: jsPsychHtmlButtonResponse,
                data: {
                    trial_type: 'demographics'
                },
                stimulus: function() {
                    return `
                        <div class="demographics-container">
                            <h2>Demographic Information</h2>
                            <div class="form-group">
                                <label for="age">Age:</label>
                                <input type="number" id="age" min="18" max="100" required>
                            </div>
                            <div class="form-group">
                                <label for="gender">Gender:</label>
                                <select id="gender" required>
                                    <option value="">Select gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="prefer-not">Prefer not to say</option>
                                </select>
                            </div>
                        </div>
                    `;
                },
                choices: ['Continue'],
                button_html: '<button class="jspsych-btn" style="background-color: #3498db; color: white; font-size: 18px; padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">%choice%</button>',
                on_load: function() {
                    const continueBtn = document.querySelector('.jspsych-btn');
                    continueBtn.disabled = true;

                    function validateForm() {
                        const age = document.getElementById('age')?.value;
                        const gender = document.getElementById('gender')?.value;
                        if (age && gender) {
                            continueBtn.disabled = false;
                            jsPsych.data.get().addToLast({
                                age: parseInt(age),
                                gender: gender
                            });
                        } else {
                            continueBtn.disabled = true;
                        }
                    }

                    document.getElementById('age')?.addEventListener('input', validateForm);
                    document.getElementById('gender')?.addEventListener('change', validateForm);
                }
            };

            const instructions = {
                type: jsPsychHtmlButtonResponse,
                stimulus: instructionsContent,
                choices: ['Start Rating!'],
                button_html: '<button class="jspsych-btn" style="background-color: #3498db; color: white; font-size: 18px; padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">%choice%</button>'
            };

            let currentRating = null;
            const trials = sentences.map(pair => ({
                type: jsPsychHtmlButtonResponse,
                data: {
                    trial_type: 'html-button-response',
                    english: pair.English,
                    italian: pair.Italian
                },
                stimulus: function() {
                    currentRating = null;
                    return `
                        <div class="sentence-pair" role="region" aria-label="Sentence Pair">
                            <div class="english" role="text" lang="en">${pair.English}</div>
                            <div class="italian" role="text" lang="it">${pair.Italian}</div>
                        </div>
                        <div class="rating-container" role="region" aria-label="Danger Rating">
                            <h3>How dangerous is this sentence?</h3>
                            <div class="rating-scale">
                                <div class="rating-buttons" role="radiogroup" aria-label="Danger rating scale from 0 to 9">
                                    ${Array.from({length: 10}, (_, i) => 
                                        `<button 
                                            class="rating-button" 
                                            data-rating="${i}" 
                                            role="radio" 
                                            aria-checked="false"
                                            aria-label="Rating ${i}"
                                        >${i}</button>`
                                    ).join('')}
                                </div>
                                <div class="scale-labels">
                                    <div class="scale-label left" aria-hidden="true">Very Safe</div>
                                    <div class="scale-label right" aria-hidden="true">Very Dangerous</div>
                                </div>
                            </div>
                        </div>
                    `;
                },
                choices: ['Next'],
                button_html: '<button class="jspsych-btn" style="background-color: #3498db; color: white; font-size: 18px; padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">%choice%</button>',
                on_load: function() {
                    const nextButton = document.querySelector('.jspsych-btn');
                    nextButton.disabled = true;
                    nextButton.classList.add('btn-next');
                    
                    document.querySelectorAll('.rating-button').forEach(button => {
                        button.addEventListener('click', function() {
                            document.querySelectorAll('.rating-button').forEach(b => {
                                b.classList.remove('selected');
                                b.setAttribute('aria-checked', 'false');
                            });
                            
                            this.classList.add('selected');
                            this.setAttribute('aria-checked', 'true');
                            currentRating = parseInt(this.dataset.rating);
                            
                            nextButton.disabled = false;
                            nextButton.classList.add('ready');
                        });
                    });
                },
                on_finish: function(data) {
                    data.english = pair.English;
                    data.italian = pair.Italian;
                    data.danger_rating = currentRating;
                    data.user_id = userID;
                }
            }));

            const end = {
                type: jsPsychHtmlButtonResponse,
                stimulus: `
                    <h2>Thank you!</h2>
                    <p>Please click 'Finish' to save your data.</p>
                    <p>Wait a minute before closing the window.</p>
                `,
                choices: ['Finish'],
                button_html: '<button class="jspsych-btn" style="background-color: #3498db; color: white; font-size: 18px; padding: 10px 30px; border-radius: 25px; border: none; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">%choice%</button>'
            };

            // Create timeline
            const timeline = [
                welcome,
                demographics,
                instructions,
                ...trials,
                end
            ];

            jsPsych.run(timeline);

        } catch (error) {
            console.error('Error loading sentences:', error);
            document.body.innerHTML = 'Error loading experiment. Please check the console for details.';
        }
    }

    loadExperiment();
</script>
</html>
